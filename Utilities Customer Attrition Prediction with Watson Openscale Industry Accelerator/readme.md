# Utilities Customer Attrition Prediction with Watson Openscale

Download the project `utilities-customer-attrition-prediction-using-WatsonOpenscale-industry-accelerator.tar.gz` from the Releases `CPDv3.5.x` and import it into Cloud Pak for Data V3.5.x. You can also follow the instructions from the [Community Page](https://community.ibm.com/community/user/cloudpakfordata/viewdocument/utilities-customer-attrition-predic) to download and import the project.

## Introduction

The Utilities Customer Attrition Prediction accelerator includes a structured glossary of more than 150 business terms and a set of sample data science assets. The glossary provides the information architecture that you need to understand why customers attrit. Your data scientists can use the sample notebooks, predictive model, Watson Openscale and dashboard to accelerate data preparation, machine learning modeling, monitoring model deployment and data reporting. Understand the likelihood of Customer Attrition occurring & analyse the business metrics influencing the Attrition.


- [Instructions](#instructions)
- [Sample data assets](#data-assets)
- [Notebooks](#notebooks)
- [R Shiny dashboard](#dashboard)
- [Sample business glossary](#glossary)


<a id="instructions"></a>
## Instructions
Follow these steps to implement the industry accelerator:
1. Navigate to the **Assets** tab and scroll to the **Notebooks** section.

2. Edit the **1-model-training** notebook by clicking the edit icon that looks like a tiny pencil next to the notebook name. This notebook prepares the data, builds ML models, and deploys the model. Follow the instructions in the notebook to step through the execution.

3. Edit and run the **2-Monitor_wml_model_with_Watson_OpenScale** notebook. This notebook configures OpenScale to monitor the deployment, and inject records and measurements for viewing in the OpenScale Insights dashboard. This notebook also creates a de-biased model if Watson OpenScale reports a bias.
4. Launch Watson Openscale monitor by navigating to {host}/aiopenscale.
5. Edit and run the **3-App_deployment** notebook.
4. Launch the r-shiny dashboard from one of the following ways.
    - Open the URL generated by deploying r-shiny dashboard in **3-App_deployment** notebook. 
    - Navigate to **Deployments -> Spaces -> Utilities Customer Attrition using Watson Openscale Space -> Deployments -> Utilities-Customer-Attrition-Shiny-App** to find the URL of deployed r-shiny dashboard and open it in a new tab.
    - Run the dashboard from RStudio console by completing these steps: <br>
     i. Download the `utilities-customer-attrition-prediction-analytics-dashboard-v2.zip` file from the Data assets section of the **Assets** page. If you don't see the file, click **View All** to display the full list of assets.<br>
     ii. Click **Launch IDE > RStudio** on the menu bar. <br>
     iii. In the **Files** pane, select the **Upload** toolbar button and upload the `utilities-customer-attrition-prediction-analytics-dashboard-v2.zip` file into RStudio.<br>
     iv. Select the `app.R` file, and click the **Run App** toolbar button to launch the dashboard. If you see a warning message that certain packages are not installed, you can ignore it because the packages will be installed first time you run the app. <br>

5. Once the app has launched, you can perform model scoring in real time by entering your username and password on the **Client View** tab.
6. Optional. To connect the data assets used in this accelerator to the business terms in Watson Knowledge Catalog, you can edit and run the **0-map-business-terms-to-data-headers** notebook. Enter the authentication details required in the first few cells. 


<a id="data-assets"></a>
## Sample data assets

These sample data files that act as dimensional and fact tables are included in the project on the **Assets** page: <br>
- `CUSTOMER.csv`: Customer demographic data.
- `STANDARD_YEARLY_USAGE.csv`: Historical annual energy usage for each customer for previous 7 years.
- `CST_PROFILES.csv`: Customer profiling information.
- `ISSUE.csv`: Dimension table with Issue category.
- `EMPLOYMENT.csv`: Dimension table with different Employment categories.
- `LOCATION.csv`: Dimension table with location data such as addresses and coordinates.
- `EDUCATION.csv`: Dimension table with different Education categories.
- `MARITAL_STATUS.csv`: Dimension table with marital status categories. M - Married, S - Single, U - Unknown
- `OFFER.csv` : Dimension table with different offers which were available to customers.
- `CONTRACT.csv` : Dimension table with contracts which were available to customers.
- `CST_SEGMENT.csv` : Dimension table with segment categories for customers.
- `Attrition View.csv` : Joining the above datasets, we created a csv file that is used as raw data input for the data preparation in `1-model-training` notebook. Refer to `Attrition View Creation Query.sql` for the SQL query used to merge the tables.


Additionally, there is another dataset created via the analytics project :<br>
- `model output summary.csv` : Consolidated prepped data after attrition prediction for Exploratory data analysis and data visualization in the R shiny dashboard.<br>


<a id="notebooks"></a>
## Notebooks

Follow the instructions in the notebooks to step through the execution.
- **1-model-training**: This notebook performs the following functions: 
    - Load data
    -  Prepare and clean data for model training
    - Analyze correlations
    - Build ML models
    -  Analyze and visualize the data
    -  Select best performing ML model, create the final pipeline and save to Cloud Pak for Data
    - Store the pipeline in the space and deploy the model.
- **2-Monitor_wml_model_with_Watson_OpenScale**: This notebook performs the following functions: 
    - Programmatically set up and configure OpenScale
    - Create a data mart for the model with Watson OpenScale and configure OpenScale to monitor that deployment, and inject records and measurements for viewing in the OpenScale Insights dashboard. 
    - Create a de-biased model if Watson OpenScale reports a bias.<br>
* **3-App_deployment** : This notebook performs the following functions: 
    - Store and deploy R Shiny app
    - Generate URL to view the app.

- **0-map-business-terms-to-data-headers**: This optional notebook performs the following functions: 
    - Publish the **Attrition View.csv** file into a specified catalog. 
    - Read mappings from **utilities customer attrition prediction map terms.csv** and applies business terms to the published dataset headers.

### IBM Watson Openscale

Watson Openscale analyses model quality, fairness, explanation and drift in the model over time. <br>
* **Quality** : Quality monitoring determines how well your model predicts outcomes. When quality monitoring is enabled, it generates a set of metrics every hour by default. You can generate these metrics on demand by clicking the Check quality now button or by using the Python client in the notebook.[More details here.](https://cloud.ibm.com/docs/ai-openscale?topic=ai-openscale-acc-monitor) <br>
* **Fairness** : Watson OpenScale fairness monitoring determines whether outcomes that are produced by your model are fair or not for monitored group. If your model is biased for certain attributes then it automatically creates a debiased model and deploys into the deployment space. [More details here.](https://cloud.ibm.com/docs/ai-openscale?topic=ai-openscale-anlz_metrics_fairness)
* **Explainability** : This feature shows how different values can change the outcome of a specific transaction. [More details here.](https://cloud.ibm.com/docs/ai-openscale?topic=ai-openscale-ie-ov)
* **Drift** : The drift is measured as the drop in accuracy and drop in data consistency as compared to model accuracy at training time. [More details here.](https://cloud.ibm.com/docs/ai-openscale?topic=ai-openscale-behavior-drift-config)
<a id="dashboard"></a>

Utilities Customer Attrition Watson Openscale monitor would look like below.![alt text](https://s3.amazonaws.com/higherlogicdownload/IMWUC/UploadedImages/ohEPgsMDQNQqTOiUYbfm_Watson-OpenScale.png)

## R Shiny dashboard
The Shiny dashboard displays model insights, customer summaries and scores new data using de-biased model generated by Watson Openscale. The dashboard has the following tabs:

* **Model Insights** : This tab contains results from **1-model_training** notebook. The model was applied to the training data and the results of this data are displayed.. The user can see how many customers were in the training data, how many were predicted to attrit and the attrition rate. The cumulative gains and lift charts for this data are also plotted. This data can be filtered by Gender, Marital Status, customer segment, city, historical complaints, warranty and tenure. The tab also contains a table of data which was the validation and test data in **1-model_training** notebook. This data is used to simulate new data which has just been scored by the model and for which we don't yet know the true target value, whether they actually attrited or not. By clicking on a point on the cumulative gains chart this table is filtered and can be exported. An analyst or marketer can use this to target a specific percentage of customers instead of having to contact all customers.  
<br>

* **Client View** : Targets individual client information, depicts the top account and Utilities retail details for the customer. It provides the option to predict Customer Attrition for the selected customer by providing de-biased endpoint generated by Watson Openscale. This de-biased endpoint can be found in  **2-Monitor_wml_model_with_Watson_OpenScale** notebook, alternatively this endpoint can be copied from the Watson Openscale monitor by navigating to **Configure Monitors -> Endpoints -> From the Endpoint list, select Debiased transactions -> From the Code language list, choose the type of code -> copy URL from the code snippet.**
<br>

* **Simulation Tool** : This tab contains a form with all model inputs. The user can change any of these inputs and see the impact that the change has on the attrition prediction probability.


<a id="glossary"></a>
## Business glossary for use with Watson Knowledge Catalog
Optionally, you can import the glossary of business terms into Watson Knowledge Catalog to get started on data governance using the below files available in the project tar file. <br>
The `utilities-customer-attrition-glossary-categories.csv` file defines the main and sub categories for the business terms. <br>
The `utilities-customer-attrition-glossary-terms.csv` file defines the business terms, category of the business terms and their Related Terms/Part of Terms, if applicable. <br>

Once the glossary is imported into Watson Knowledge Catalog, Publish the Business Terms, Navigate to **Governance > Categories > Industry Accelerator > Utilities Customer Attrition Prediction** to explore the glossary contents. 

### Terms and Conditions
This project contains Sample Materials, provided under license. <br>
Licensed Materials - Property of IBM. <br>
Â© Copyright IBM Corp. 2020, 2021. All Rights Reserved. <br>
US Government Users Restricted Rights - Use, duplication or disclosure restricted by GSA ADP Schedule Contract with IBM Corp.<br><br/>



 
